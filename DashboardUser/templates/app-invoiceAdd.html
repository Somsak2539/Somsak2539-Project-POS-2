{% extends "LayoutDashbords.html"%}
{% load humanize %}

{% load static %}






{% block title%}
invoice
{% endblock %}



{% block content%}

<div class="relative min-h-screen group-data-[sidebar-size=sm]:min-h-sm">

    <div
        class="group-data-[sidebar-size=lg]:ltr:md:ml-vertical-menu group-data-[sidebar-size=lg]:rtl:md:mr-vertical-menu group-data-[sidebar-size=md]:ltr:ml-vertical-menu-md group-data-[sidebar-size=md]:rtl:mr-vertical-menu-md group-data-[sidebar-size=sm]:ltr:ml-vertical-menu-sm group-data-[sidebar-size=sm]:rtl:mr-vertical-menu-sm pt-[calc(theme('spacing.header')_*_1)] pb-[calc(theme('spacing.header')_*_0.8)] px-4 group-data-[navbar=bordered]:pt-[calc(theme('spacing.header')_*_1.3)] group-data-[navbar=hidden]:pt-0 group-data-[layout=horizontal]:mx-auto group-data-[layout=horizontal]:max-w-screen-2xl group-data-[layout=horizontal]:px-0 group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:ltr:md:ml-auto group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:rtl:md:mr-auto group-data-[layout=horizontal]:md:pt-[calc(theme('spacing.header')_*_1.6)] group-data-[layout=horizontal]:px-3 group-data-[layout=horizontal]:group-data-[navbar=hidden]:pt-[calc(theme('spacing.header')_*_0.9)]">
        <div class="container-fluid group-data-[content=boxed]:max-w-boxed mx-auto">

            <div class="flex flex-col gap-2 py-4 md:flex-row md:items-center print:hidden">
                <div class="grow">
                    <h5 class="text-16">เพิ่มรายการ</h5>
                </div>
                <ul class="flex items-center gap-2 text-sm font-normal shrink-0">
                    <li
                        class="relative before:content-['\ea54'] before:font-remix ltr:before:-right-1 rtl:before:-left-1  before:absolute before:text-[18px] before:-top-[3px] ltr:pr-4 rtl:pl-4 before:text-slate-400 dark:text-zink-200">
                        <a href="#!" class="text-slate-400 dark:text-zink-200">เอกสาร</a>
                    </li>
                    <li class="text-slate-700 dark:text-zink-100">
                        เพิ่มเอกสาร
                    </li>
                </ul>
            </div>
            <div class="grid items-center grid-cols-1 gap-5 mb-5 xl:grid-cols-12">
                <div class="xl:col-span-2">
                    <h5 class="text-16">ร่างเอกสารใหม่</h5>
                </div><!--end col-->
                <div class="xl:col-span-3 xl:col-start-10">
                    <div class="flex justify-end gap-2">
                        <button type="button"
                            class="text-slate-500 btn bg-slate-200 border-slate-200 hover:text-slate-600 hover:bg-slate-300 hover:border-slate-300 focus:text-slate-600 focus:bg-slate-300 focus:border-slate-300 focus:ring focus:ring-slate-100 active:text-slate-600 active:bg-slate-300 active:border-slate-300 active:ring active:ring-slate-100 dark:bg-zink-600 dark:hover:bg-zink-500 dark:border-zink-600 dark:hover:border-zink-500 dark:text-zink-200 dark:ring-zink-400/50"><i
                                data-lucide="eye" class="inline-block mr-1 size-4"></i> <span
                                class="align-middle">Preview</span></button>
                        <button type="button"
                            class="text-white bg-purple-500 border-purple-500 btn hover:text-white hover:bg-purple-600 hover:border-purple-600 focus:text-white focus:bg-purple-600 focus:border-purple-600 focus:ring focus:ring-purple-100 active:text-white active:bg-purple-600 active:border-purple-600 active:ring active:ring-purple-100 dark:ring-purple-400/10">Save
                            Draft</button>
                        <button type="button"
                            class="text-white btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20"><i
                                data-lucide="save" class="inline-block mr-1 size-4"></i> <span class="align-middle">Save
                                & Download</span></button>
                    </div>
                </div>
            </div><!--end grid-->

            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <h6 class="mb-4 text-gray-800 underline text-16 dark:text-zink-50">ข้อมูลทั่วไป:</h6>
                        <div class="grid grid-cols-1 gap-5 xl:grid-cols-12">

                            <div class="xl:col-span-3">
                                <label for="paymentStatus"
                                    class="inline-block mb-2 text-base font-medium">ประเภทเอกสาร</label>
                                <select
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    data-choices="" data-choices-search-false="" name="document_type"
                                    id="document_type">
                                    <option value="">เลือกประเภทเอกสาร</option>
                                    <option value="invoice">ใบแจ้งหนี้</option>
                                    <option value="tax_invoice">ใบกำกับภาษี</option>
                                    <option value="quotation">ใบเสนอราคา</option>
                                    <option value="po">ใบสั่งซื้อ (PO)</option>
                                    <option value="pr">ใบขอซื้อ (PR)</option>
                                </select>
                            </div><!--end col-->

                            <div class="xl:col-span-3">
                                <label for="date"
                                    class="inline-block mb-2 text-base font-medium">วันที่ออกเอกสาร</label>
                                <input type="datetime-local" id="date" name="date"
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    required>
                            </div><!--end col-->
                            <div class="xl:col-span-3">
                                <label for="due_date" class="inline-block mb-2 text-base font-medium">กำหนดชำระ</label>
                                <input type="date" id="due_date" name="due_date"
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    required>
                            </div><!--end col-->




                        </div><!--end grid-->

                        <h6 class="my-5 underline text-16">ลูกค้า</h6>
                        <div class="grid grid-cols-1 gap-5 xl:grid-cols-12 changeAddress">
                            <div class="xl:col-span-3">

                                <select
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    data-choices="" data-choices-search-false="" name="customer" id="customer">
                                    <option value="">เลือกรายการลูกค้า</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div><!--end col-->

                        </div><!--end grid-->


                        <h6 class="my-5 underline text-16">ผู้ออกบิล</h6>
                        <div class="grid grid-cols-1 gap-5 xl:grid-cols-12 changeAddress">
                            <div class="xl:col-span-3">

                                <select
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    data-choices="" data-choices-search-false="" name="seller" id="seller">
                                    <option value="">เลือกรายการผู้ออกบิล</option>
                                    {% for seller in sellers %}
                                    <option value="{{ seller.id }}">{{ seller.name }}</option>
                                    {% endfor %}
                                </select>
                            </div><!--end col-->


                            <div class="xl:col-span-12">
                                <label for="notes" class="inline-block mb-2 text-base font-medium">หมายเหตุ :</label>
                                <textarea
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    placeholder="หมายเหตุ" id="notes" name="notes" rows="3"></textarea>
                            </div><!--end col-->

                        </div><!--end grid-->


                        <!-- <div class="flex items-center mt-5">
                            <div class="relative inline-block w-10 mr-2 align-middle transition duration-200 ease-in">
                                <input type="checkbox" name="updateStock" id="updateStock" class="absolute block transition duration-300 ease-linear border-2 rounded-full appearance-none cursor-pointer size-5 border-slate-200 dark:border-zink-600 bg-white/80 dark:bg-zink-400 peer/published checked:bg-custom-500 dark:checked:bg-custom-500 ltr:checked:right-0 rtl:checked:left-0 checked:border-custom-100 dark:checked:border-custom-900 arrow-none checked:bg-none">
                                <label for="updateStock" class="block h-5 overflow-hidden duration-300 ease-linear border rounded-full cursor-pointer cursor-pointertransition border-slate-200 dark:border-zink-500 bg-slate-200 dark:bg-zink-600 peer-checked/published:bg-custom-100 dark:peer-checked/published:bg-custom-900 peer-checked/published:border-custom-100 dark:peer-checked/published:border-custom-900"></label>
                            </div>
                            <label for="updateStock" class="inline-block text-base font-medium">ต้องการที่จะตัด Stock หรือไม่?</label>
                        </div>

                         -->

                        <div class="flex items-center mt-5">
                            <div class="relative inline-block w-10 mr-2 align-middle transition duration-200 ease-in">
                                <input type="checkbox" name="includeVat" id="includeVat"
                                    class="absolute block transition duration-300 ease-linear border-2 rounded-full appearance-none cursor-pointer size-5 border-slate-200 dark:border-zink-600 bg-white/80 dark:bg-zink-400 peer/published checked:bg-custom-500 dark:checked:bg-custom-500 ltr:checked:right-0 rtl:checked:left-0 checked:border-custom-100 dark:checked:border-custom-900 arrow-none checked:bg-none">
                                <label for="includeVat"
                                    class="block h-5 overflow-hidden duration-300 ease-linear border rounded-full cursor-pointer cursor-pointertransition border-slate-200 dark:border-zink-500 bg-slate-200 dark:bg-zink-600 peer-checked/published:bg-custom-100 dark:peer-checked/published:bg-custom-900 peer-checked/published:border-custom-100 dark:peer-checked/published:border-custom-900"></label>
                            </div>
                            <label for="includeVat" class="inline-block text-base font-medium">ราคาสินค้ารวม VAT แล้ว
                                **คุณจำเป็นต้องเพิ่มรายการทั้งหมดก่อนไม่งั้นมันจะจำค่าเริ่มต้น**</label>
                        </div>


                        <!-- <h6 class="my-5 underline text-16">Billing Info:</h6>
                        <div class="grid grid-cols-1 gap-5 xl:grid-cols-12">
                           




                        </div> end grid-->

                        <h6 class="my-5 underline text-16">รายการ Proudct :</h6>

                        <div class="overflow-x-auto">
                            <table class="w-full whitespace-nowrap">
                                <thead>
                                    <tr>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500">
                                            Item Name</th>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500">
                                            จำนวณ</th>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500">
                                            ราคา</th>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500">
                                            ลดราคา %</th>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500">
                                            TAX 7%</th>
                                        <th
                                            class="px-3.5 py-2.5 font-medium text-sm text-slate-500 uppercase border border-slate-200 dark:text-zink-200 dark:border-zink-500 w-44">
                                            รวม</th>
                                    </tr>
                                </thead>




                                <tbody class="before:block before:h-3 item-list" id="product-table-body">
                                    <tr class="item">
                                        <td>
                                            <select name="product_id[]" class="form-input select2-product" required>
                                                <option value="">เลือกรายการสินค้า</option>
                                                {% for product in products %}
                                                <option value="{{ product.id }}" data-price="{{ product.price }}"
                                                    data-stock="{{ product.stock }}" data-tax="{{ product.tax }}">
                                                    {{ product.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="quantity[]" class="form-input quantity" value="1"
                                                min="1" required>
                                        </td>
                                        <td>
                                            <input type="number" name="price[]" class="form-input price" step="0.01"
                                                min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="discount[]" class="form-input discount" value="0"
                                                min="0" max="100">
                                        </td>
                                        <td>
                                            <input type="number" name="tax[]" class="form-input tax" value="7" readonly>
                                        </td>
                                        <td class="text-center">
                                            <div class="flex items-center justify-center gap-3">
                                                <input type="number" name="total[]"
                                                    class="form-input total border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 w-32"
                                                    value="0" readonly>
                                                <button type="button"
                                                    class="btn btn-danger btn-remove-row flex items-center gap-1.5 px-3 py-1.5 rounded-md shadow-sm hover:bg-red-600 hover:shadow-md transition-all duration-200">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    <span class="text-sm font-medium">ลบ</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                </tbody>

                                <tbody class="before:block before:h-4" id="invoiceTable">
                                    <tr>
                                        <td colspan="6" class="py-4">
                                            <button type="button" id="add-row-btn"
                                                class="btn bg-custom-500 text-white border-custom-500 hover:bg-custom-600 hover:border-custom-600 focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:bg-custom-600 active:border-custom-600 flex items-center gap-2 px-4 py-2.5 rounded-md shadow-sm hover:shadow-md transition-all duration-200">
                                                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                                <span class="font-medium">เพิ่มรายการสินค้า</span>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tbody class="before:block before:h-3" id="totalAmount">
                                    <tr>
                                        <td colspan="4"></td>
                                        <td
                                            class="border-b border-slate-200 px-3.5 py-2.5 text-slate-500 dark:text-zink-200 dark:border-zink-500">
                                            รวมทั้งหมด
                                        </td>
                                        <td class="font-medium border-b border-slate-200 dark:border-zink-500">
                                            <input type="text" id="subTotale"
                                                class="px-3.5 py-2.5 border-none form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200 cart-subtotal"
                                                placeholder="00.00 บาท" readonly="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4"></td>
                                        <td
                                            class="border-b border-slate-200 px-3.5 py-2.5 text-slate-500 dark:text-zink-200 dark:border-zink-500">
                                            Tax (7%)
                                        </td>
                                        <td class="font-medium border-b border-slate-200 dark:border-zink-500">
                                            <input type="text" id="estimatedTax"
                                                class="px-3.5 py-2.5 border-none form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200 cart-tax"
                                                placeholder="00.00 บาท " readonly="">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4"></td>
                                        <td
                                            class="border-b border-slate-200 px-3.5 py-2.5 text-slate-500 dark:text-zink-200 dark:border-zink-500">
                                            ลดราคา
                                        </td>
                                        <td
                                            class="font-medium border-b border-slate-200 dark:border-zink-500 text-slate-500">
                                            <input type="text" id="itemDiscounts"
                                                class="px-3.5 py-2.5 border-none form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200 cart-discount"
                                                placeholder="-00.00 บาท" readonly="">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="4"></td>
                                        <td
                                            class="border-b border-slate-200 px-3.5 py-2.5 text-slate-500 dark:text-zink-200 dark:border-zink-500">
                                            รวมทั้งหมด
                                        </td>
                                        <td class="font-medium border-b border-slate-200 dark:border-zink-500">
                                            <input type="text" id="totalAmount1"
                                                class="px-3.5 py-2.5 border-none form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200 cart-total"
                                                placeholder="00.00 บาท" readonly="">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <div class="grid grid-cols-1 gap-5 xl:grid-cols-12">


                            <div class="xl:col-span-12">
                                <label for="taxBillingInput"
                                    class="inline-block mb-2 text-base font-medium">Notes</label>
                                <textarea
                                    class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200"
                                    placeholder="รายระเอียดต่างๆ" id="taxBillingInput" rows="3"></textarea>
                            </div><!--end col-->

                        </div><!--end grid-->

                        <div class="flex justify-end gap-2 mt-5">
                            <button type="button"
                                class="text-slate-500 btn bg-slate-200 border-slate-200 hover:text-slate-600 hover:bg-slate-300 hover:border-slate-300 focus:text-slate-600 focus:bg-slate-300 focus:border-slate-300 focus:ring focus:ring-slate-100 active:text-slate-600 active:bg-slate-300 active:border-slate-300 active:ring active:ring-slate-100 dark:bg-zink-600 dark:hover:bg-zink-500 dark:border-zink-600 dark:hover:border-zink-500 dark:text-zink-200 dark:ring-zink-400/50"><i
                                    data-lucide="refresh-ccw" class="inline-block mr-1 size-4"></i> <span
                                    class="align-middle">Reset</span></button>
                            <button type="button" id="saveInvoiceBtn"
                                class="text-white btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20"><i
                                    data-lucide="save" class="inline-block mr-1 size-4"></i> <span
                                    class="align-middle">Save</span></button>
                            <button type="button"
                                class="text-white bg-green-500 border-green-500 btn hover:text-white hover:bg-green-600 hover:border-green-600 focus:text-white focus:bg-green-600 focus:border-green-600 focus:ring focus:ring-green-100 active:text-white active:bg-green-600 active:border-green-600 active:ring active:ring-green-100 dark:ring-green-400/10"><i
                                    data-lucide="download" class="inline-block mr-1 size-4"></i> <span
                                    class="align-middle">Download</span></button>
                        </div>



                    </form>
                </div>
            </div><!--end card-->

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <footer
        class="ltr:md:left-vertical-menu rtl:md:right-vertical-menu group-data-[sidebar-size=md]:ltr:md:left-vertical-menu-md group-data-[sidebar-size=md]:rtl:md:right-vertical-menu-md group-data-[sidebar-size=sm]:ltr:md:left-vertical-menu-sm group-data-[sidebar-size=sm]:rtl:md:right-vertical-menu-sm absolute right-0 bottom-0 px-4 h-14 group-data-[layout=horizontal]:ltr:left-0  group-data-[layout=horizontal]:rtl:right-0 left-0 border-t py-3 flex items-center dark:border-zink-600">
        <div class="group-data-[layout=horizontal]:mx-auto group-data-[layout=horizontal]:max-w-screen-2xl w-full">
            <div
                class="grid items-center grid-cols-1 text-center lg:grid-cols-2 text-slate-400 dark:text-zink-200 ltr:lg:text-left rtl:lg:text-right">
                <div>
                    <script>document.write(new Date().getFullYear())</script> Somsak Sonngai
                </div>
                <div class="hidden lg:block">
                    <div class="ltr:text-right rtl:text-left">
                        Design & Develop by Somsak Sonngai
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- เพิ่ม JavaScript สำหรับจัดการข้อมูล -->
<script>
    $(document).ready(function () {
        // กำหนด Select2
        $('.select2-product').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // เมื่อเลือกสินค้า
        $(document).on('change', '.select2-product', function () {
            var row = $(this).closest('tr');
            var selectedOption = $(this).find('option:selected');

            // กำหนดค่าเริ่มต้น
            var price = selectedOption.data('price') || 0;
            var tax = selectedOption.data('tax') || 7;

            // อัพเดทค่าใน input เฉพาะเมื่อยังไม่ได้กำหนดราคาเอง
            if (!row.find('.price').val()) {
                row.find('.price').val(price);
            }
            row.find('.tax').val(tax);

            // คำนวณราคารวม
            calculateRowTotal(row);
        });

        // คำนวณราคารวมเมื่อมีการเปลี่ยนแปลงจำนวน ราคา หรือส่วนลด
        $(document).on('input', '.quantity, .price, .discount', function () {
            calculateRowTotal($(this).closest('tr'));
        });

        // ฟังก์ชันคำนวณราคารวม
        function calculateRowTotal(row) {
            var quantity = parseFloat(row.find('.quantity').val()) || 0;
            var price = parseFloat(row.find('.price').val()) || 0;
            var discount = parseFloat(row.find('.discount').val()) || 0;
            var tax = parseFloat(row.find('.tax').val()) || 0;

            // คำนวณราคารวม
            var subtotal = quantity * price;
            var discountAmount = (subtotal * discount) / 100;
            var afterDiscount = subtotal - discountAmount;
            var taxAmount = (afterDiscount * tax) / 100;
            var total = afterDiscount + taxAmount;

            // แสดงผลลัพธ์
            row.find('.total').val(total.toFixed(2));

            // อัพเดทยอดรวมทั้งหมด
            calculateGrandTotal();
        }

        // ฟังก์ชันคำนวณยอดรวมทั้งหมด
        function calculateGrandTotal() {
            var subtotal = 0;
            var totalTax = 0;
            var totalDiscount = 0;

            $('.item').each(function () {
                var row = $(this);
                var quantity = parseFloat(row.find('.quantity').val()) || 0;
                var price = parseFloat(row.find('.price').val()) || 0;
                var discount = parseFloat(row.find('.discount').val()) || 0;
                var tax = parseFloat(row.find('.tax').val()) || 0;

                var rowSubtotal = quantity * price;
                var rowDiscount = (rowSubtotal * discount) / 100;
                var rowAfterDiscount = rowSubtotal - rowDiscount;
                var rowTax = (rowAfterDiscount * tax) / 100;

                subtotal += rowSubtotal;
                totalDiscount += rowDiscount;
                totalTax += rowTax;
            });

            var grandTotal = subtotal - totalDiscount + totalTax;

            // อัพเดทยอดรวมในตารางสรุป
            $('#subTotale').val(subtotal.toFixed(2));
            $('#itemDiscounts').val(totalDiscount.toFixed(2));
            $('#estimatedTax').val(totalTax.toFixed(2));
            $('#totalAmount1').val(grandTotal.toFixed(2));
        }

        // จัดการราคารวม VAT
        $('#includeVat').change(function () {
            var isChecked = $(this).is(':checked');
            $('.item').each(function () {
                var row = $(this);
                var price = parseFloat(row.find('.price').val()) || 0;
                var tax = parseFloat(row.find('.tax').val()) || 7;

                // ถ้า price ไม่ใช่ตัวเลขหรือ <= 0 ให้ข้าม
                if (isNaN(price) || price <= 0) {
                    return;
                }

                if (isChecked) {
                    // แปลงราคาเป็นราคารวม VAT
                    var priceWithVat = price / (1 + (tax / 100));;
                    row.find('.price').val(priceWithVat.toFixed(2));


                } else {
                    // แปลงราคากลับเป็นราคาไม่รวม VAT
                    var priceWithoutVat = price * (1 + (tax / 100));
                    row.find('.price').val(priceWithoutVat.toFixed(2));
                }

                calculateRowTotal(row);
            });
        });

        // จัดการการตัด Stock
        $('#updateStock').change(function () {
            var isChecked = $(this).is(':checked');
            // เพิ่มโค้ดสำหรับจัดการการตัด Stock ตามต้องการ
        });

        // เพิ่ม event handler สำหรับปุ่ม Save
        $('#saveInvoiceBtn').click(function (e) {
            e.preventDefault(); // ป้องกันการ submit form
            saveInvoice();
        });

        // ฟังก์ชันสำหรับบันทึกข้อมูล
        function saveInvoice() {
            // เก็บข้อมูลจากฟอร์ม
            var invoiceData = {
                date: $('#date').val(),
                due_date: $('#due_date').val(),
                customer_id: $('#customer').val(),
                seller_id: $('#seller').val(),
                notes: $('#notes').val(),
                update_stock: $('#updateStock').is(':checked'),
                include_vat: $('#includeVat').is(':checked'),
                items: []
            };

            // เก็บข้อมูลสินค้าแต่ละรายการ
            $('.item').each(function () {
                var row = $(this);
                var item = {
                    product_id: row.find('.select2-product').val(),
                    quantity: parseFloat(row.find('.quantity').val()) || 0,
                    price: parseFloat(row.find('.price').val()) || 0,
                    discount: parseFloat(row.find('.discount').val()) || 0,
                    tax: parseFloat(row.find('.tax').val()) || 0
                };
                invoiceData.items.push(item);
            });

            // ส่งข้อมูลไปยัง server
            $.ajax({
                url: '/save_invoice/',
                type: 'POST',
                data: {
                    invoice_data: JSON.stringify(invoiceData),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ!',
                            text: response.message,
                            confirmButtonText: 'ไปที่รายการ',
                            confirmButtonColor: '#6366f1'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = response.redirect_url;
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: response.message,
                            confirmButtonColor: '#e11d48'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
                        confirmButtonColor: '#e11d48'
                    });
                }
            });
        }



    });






</script>

{% endblock%}